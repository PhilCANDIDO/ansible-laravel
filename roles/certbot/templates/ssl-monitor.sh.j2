#!/bin/bash
# Templates de monitoring pour les certificats SSL
# SSL Certificate Expiry Monitoring Script
# Generated by Ansible - DO NOT EDIT MANUALLY

set -euo pipefail

DOMAIN="{{ certbot_primary_domain }}"
CERT_PATH="{{ certbot_fullchain_path }}"
NOTIFICATION_EMAIL="{{ certbot_expiry_notification_email }}"
NOTIFICATION_DAYS="{{ certbot_expiry_notification_days }}"
LOG_FILE="{{ certbot_logs_dir }}/monitoring.log"

# Ensure log directory exists
mkdir -p "{{ certbot_logs_dir }}"

log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $*" | tee -a "${LOG_FILE}"
}

# Check if certificate exists
if [[ ! -f "${CERT_PATH}" ]]; then
    log "ERROR: Certificate not found: ${CERT_PATH}"
    if [[ -n "${NOTIFICATION_EMAIL}" ]]; then
        echo "SSL certificate not found for ${DOMAIN} on $(hostname)" | \
            mail -s "SSL Certificate Missing - ${DOMAIN}" "${NOTIFICATION_EMAIL}" 2>/dev/null || true
    fi
    exit 1
fi

# Get certificate expiry date
EXPIRY_DATE=$(openssl x509 -enddate -noout -in "${CERT_PATH}" | cut -d= -f2)
EXPIRY_EPOCH=$(date -d "${EXPIRY_DATE}" +%s)
CURRENT_EPOCH=$(date +%s)
DAYS_UNTIL_EXPIRY=$(( (EXPIRY_EPOCH - CURRENT_EPOCH) / 86400 ))

log "Certificate for ${DOMAIN} expires in ${DAYS_UNTIL_EXPIRY} days (${EXPIRY_DATE})"

# Check if certificate is expiring soon
if [[ ${DAYS_UNTIL_EXPIRY} -le ${NOTIFICATION_DAYS} ]]; then
    log "WARNING: Certificate for ${DOMAIN} expires in ${DAYS_UNTIL_EXPIRY} days!"
    
    if [[ -n "${NOTIFICATION_EMAIL}" ]]; then
        cat << EOF | mail -s "SSL Certificate Expiring Soon - ${DOMAIN}" "${NOTIFICATION_EMAIL}" 2>/dev/null || true
SSL Certificate Expiry Warning

Domain: ${DOMAIN}
Server: $(hostname)
Days until expiry: ${DAYS_UNTIL_EXPIRY}
Expiry date: ${EXPIRY_DATE}

Certificate path: ${CERT_PATH}

Please ensure automatic renewal is working correctly or renew manually:
sudo certbot renew

---
This is an automated message from the SSL monitoring system.
EOF
        log "Expiry notification sent to ${NOTIFICATION_EMAIL}"
    fi
else
    log "Certificate for ${DOMAIN} is valid for ${DAYS_UNTIL_EXPIRY} more days"
fi
